<!-- N√∫t chat n·ªïi -->
<div class="chat-button" (click)="toggleChatList()">üí¨</div>

<!-- Danh s√°ch chat -->
<div class="chat-list" *ngIf="showChatList && !creatingGroup">
  <h4>Danh s√°ch tr√≤ chuy·ªán</h4>

  <div class="section-title">Ng∆∞·ªùi d√πng</div>
  <input
    type="text"
    placeholder="T√¨m m√£ / t√™n nh√¢n vi√™n..."
    [(ngModel)]="searchText"
    class="form-control mb-2"
  />

  <ul>
    <ng-container *ngFor="let group of groups">
      <li *ngIf="isPerson(group)" (click)="openGroupChat(group)">
        <img [src]="dmPeerAvatar(group)" class="avatar" />
        <div class="item-col">
          <div class="title">{{ dmPeerName(group) }}</div>
<!--          <div class="sub">ID: {{ dmPeerId(group) }}</div>-->
        </div>
      </li>
    </ng-container>
  </ul>

  <div class="section-title">Nh√≥m</div>
  <ul>
    <ng-container *ngFor="let group of groups">
      <li *ngIf="(group.type || '').toUpperCase() === 'GROUP'"
          (click)="openGroupChat(group)">
        <img [src]="'assets/images/icon/icon-team-group.svg'" class="avatar" />
        <div class="item-col"><div class="title">{{ group.name }}</div></div>
      </li>
    </ng-container>
  </ul>

  <button class="create-group-btn" (click)="startCreateGroup()">+ T·∫°o nh√≥m</button>
  <button class="create-group-btn" (click)="startCreateDm()">+ T·∫°o m·ªõi</button>
</div>
<div class="chat-list" *ngIf="creatingDm">
  <h4>T·∫°o tin nh·∫Øn 1-1</h4>

  <div class="section-title">Ch·ªçn ng∆∞·ªùi nh·∫≠n</div>
  <input [(ngModel)]="dmSearchTerm" placeholder="Nh·∫≠p t√™n ƒë·ªÉ t√¨m..." class="group-input" />

  <ul class="user-picker">
    <li *ngFor="let u of usersForDm">
      <label class="user-check">
        <input
          type="radio"
          name="dmUser"
          [value]="u.id"
          [checked]="selectedDmUserId === u.id"
          (change)="selectDmUser(u.id)"
        />
        <img [src]="u.logoUrl ? (url + u.logoUrl) : 'assets/images/icon/avatar.svg'" class="avatar" />
        <span>{{ u.fullname }}</span>
      </label>
    </li>
  </ul>

  <div class="group-actions">
    <button class="submit" [disabled]="!selectedDmUserId" (click)="createDm()">T·∫°o</button>
    <button class="cancel-btn" (click)="cancelCreateDm()">H·ªßy</button>
  </div>
</div>
<!-- Form t·∫°o nh√≥m -->
<div class="chat-list" *ngIf="creatingGroup">
  <h4>T·∫°o nh√≥m m·ªõi</h4>

  <label class="lbl">T√™n nh√≥m</label>
  <input [(ngModel)]="groupName" placeholder="V√≠ d·ª•: Team Sales Q3" class="group-input" />

  <div class="section-title">T√¨m & ch·ªçn th√†nh vi√™n</div>
  <input [(ngModel)]="createSearchTerm" placeholder="Nh·∫≠p t√™n ƒë·ªÉ t√¨m..." class="group-input" />

  <ul class="user-picker">
    <li *ngFor="let user of usersForCreate">
      <label class="user-check">
        <input
          type="checkbox"
          [checked]="selectedUserIds.has(user.id)"
          (change)="toggleUserSelection(user.id, $event)"
        />
        <img [src]="user.logoUrl ? (url + user.logoUrl) : 'assets/images/icon/avatar.svg'" class="avatar" />
        <span>{{ user.fullname }}</span>
      </label>
    </li>
  </ul>

  <div class="group-actions">
    <button class="submit" [disabled]="!groupName.trim() || selectedUserIds.size===0" (click)="createGroup()">T·∫°o</button>
    <button class="cancel-btn" (click)="cancelCreateGroup()">H·ªßy</button>
  </div>
</div>

<!-- ======= DOCK CH·ª®A NHI·ªÄU C·ª¨A S·ªî CHAT ======= -->
<div class="chat-dock" *ngIf="openChats.length > 0">
  <div
    class="chat-box"
    *ngFor="let w of openChats; trackBy: trackByKey"
    (mousedown)="focusWindow(w)"
    [class.is-active]="w.key === activeKey"
  >
    <!-- Header -->
    <div class="chat-header" (mousedown)="$event.stopPropagation()">
      <div class="header-left">
        <img [src]="'assets/images/icon/icon-team-group.svg'" class="avatar" />
        <div class="head-col">
          <span class="title">{{ w.data?.name }}</span>
          <span class="sub" *ngIf="w.type === 'group'"></span>
        </div>
      </div>

      <div class="header-actions">
        <button
          *ngIf="w.type==='group'"
          class="icon-only"
          (click)="toggleMenu(w); $event.stopPropagation()"
          title="Tu·ª≥ ch·ªçn"
        >‚öôÔ∏è</button>

        <!-- Menu n·ªïi -->
        <div *ngIf="w.type==='group' && w.showMenu" class="app-menu" (click)="$event.stopPropagation()">
          <div class="menu-item" (click)="toggleMemberPanel(w)">üë• Th√†nh vi√™n</div>
          <div class="menu-item" (click)="openRenameModalFor(w)">‚úèÔ∏è ƒê·ªïi t√™n nh√≥m</div>
          <div class="menu-item danger" (click)="openDeleteConfirmFor(w)">üóëÔ∏è X√≥a nh√≥m</div>
        </div>

        <button
          class="close-btn"
          (click)="closeChatWindow(w.key); $event.stopPropagation()"
          title="ƒê√≥ng"
        >‚úñ</button>
      </div>
    </div>

    <!-- Member panel -->
    <div *ngIf="w.type==='group' && w.showMemberPanel" class="member-panel">
      <div class="section-title" style="margin:0 0 8px;">Qu·∫£n l√Ω th√†nh vi√™n</div>
      <div class="member-grid">
        <div>
          <input [(ngModel)]="w.memberSearchTerm" placeholder="T√¨m ng∆∞·ªùi d√πng ƒë·ªÉ th√™m..." class="group-input" />
          <ul class="user-picker" *ngIf="addableUsersFor(w).length > 0" style="list-style: none;margin: 0;padding: 0;">
            <li *ngFor="let u of addableUsersFor(w)" style="list-style: none;">
              <div class="user-check row-justified">
                <div class="row-left">
                  <img [src]="u.logoUrl ? (url+u.logoUrl) : 'assets/images/icon/avatar.svg'" class="avatar" />
                  <span>{{ u.fullname }}</span>
                </div>
                <button class="submit btn" (click)="addMemberToGroupWindow(w, u)">+ Th√™m</button>
              </div>
            </li>
          </ul>
          <div *ngIf="addableUsersFor(w).length === 0" class="sub">Kh√¥ng c√≥ ng∆∞·ªùi d√πng ph√π h·ª£p.</div>
        </div>

        <div>
          <div class="section-title" style="margin:10px 0 6px;">Th√†nh vi√™n hi·ªán t·∫°i</div>
          <ul class="user-picker" *ngIf="currentMembersFor(w).length > 0" style="list-style: none;margin: 0;padding: 0;">
            <li *ngFor="let m of currentMembersFor(w)">
              <div class="user-check row-justified">
                <div class="row-left">
                  <img [src]="m.logoUrl ? (url+m.logoUrl) : 'assets/images/icon/avatar.svg'" class="avatar" />
                  <span>{{ m.fullname }}</span>
                </div>
                <button class="cancel-btn btn" (click)="removeMemberFromGroupWindow(w, m.id)">X√≥a</button>
              </div>
            </li>
          </ul>
          <div *ngIf="currentMembersFor(w).length === 0" class="sub">Ch∆∞a c√≥ th√†nh vi√™n.</div>
        </div>
      </div>
    </div>

    <!-- Chat body -->
    <div class="chat-body" *ngIf="!w.showMemberPanel" (mousedown)="$event.stopPropagation()">
      <div *ngFor="let msg of (chatMessages[w.key] || []); trackBy: trackMessage" class="msg-wrap">
        <div [ngClass]="msg.from === 'me' ? 'msg me' : 'msg other'">

          <ng-container *ngIf="msg.from === 'other'">
            <div class="msg-header">
              <img [src]="msg.avatar ? (url + msg.avatar) : 'assets/images/icon/avatar.svg'" class="avatar" />
              <span class="fullname">{{ msg.fullname }}</span>
            </div>
          </ng-container>

          <div *ngIf="msg.text" class="msg-text">{{ msg.text }}</div>

          <ng-container *ngIf="!msg.text && msg.fileUrl">
            <div *ngIf="msg.isImage; else fileLink" class="file-image">
              <img [src]="msg.fileUrl" alt="img" class="chat-img" />
              <div class="file-name">{{ msg.fileName }}</div>
            </div>
            <ng-template #fileLink>
              <a [href]="msg.fileUrl" download class="file-link">üìé {{ msg.fileName }}</a>
            </ng-template>
          </ng-container>

          <div class="time">{{ msg.time | date : 'shortTime' }}</div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="chat-footer" *ngIf="!w.showMemberPanel" (mousedown)="$event.stopPropagation()">
      <div class="picked-file" *ngIf="w.selectedFile">
        <span>üìé {{ w.selectedFile.name }}</span>
        <button class="x" (click)="removeSelectedFileFor(w)">‚úï</button>
      </div>

      <input type="file" (change)="onFileSelectedFor($event, w)" hidden #fileInputWin />
      <button class="icon-btn" title="ƒê√≠nh k√®m" (click)="fileInputWin.click()">üìé</button>

      <textarea
        [(ngModel)]="w.newMessage"
        (keydown)="handleEnterToSendFor($event, w)"
        placeholder="Nh·∫≠p tin nh·∫Øn..."
        rows="1"
      ></textarea>

      <button class="send-btn" (click)="sendMessageFor(w)">G·ª≠i</button>
    </div>
  </div>
</div>

<!-- ===== Modals ===== -->

<!-- Rename Modal -->
<div class="app-modal-backdrop" *ngIf="showRenameModal" (click)="showRenameModal=false">
  <div class="app-modal" (click)="$event.stopPropagation()">
    <h4>ƒê·ªïi t√™n nh√≥m</h4>
    <input class="group-input" [(ngModel)]="newGroupName" placeholder="Nh·∫≠p t√™n nh√≥m m·ªõi" />
    <div class="modal-actions">
      <button class="cancel-btn" (click)="showRenameModal=false">H·ªßy</button>
      <button class="submit" [disabled]="!newGroupName.trim()" (click)="saveRename()">L∆∞u</button>
    </div>
  </div>
</div>

<!-- Avatar Modal -->
<div class="app-modal-backdrop" *ngIf="showAvatarModal" (click)="showAvatarModal=false">
  <div class="app-modal" (click)="$event.stopPropagation()">
    <h4>ƒê·ªïi ·∫£nh nh√≥m</h4>
    <div class="avatar-preview">
      <img [src]="avatarPreview || (activeGroup?.avatar || '')" class="avatar-lg" alt="preview" />
    </div>
    <input type="file" (change)="onAvatarFileSelected($event)" />
    <div class="modal-actions">
      <button class="cancel-btn" (click)="showAvatarModal=false">H·ªßy</button>
      <button class="submit" [disabled]="!avatarPreview" (click)="saveAvatar()">L∆∞u</button>
    </div>
  </div>
</div>

<!-- Delete Confirm -->
<div class="app-modal-backdrop" *ngIf="showDeleteConfirm" (click)="showDeleteConfirm=false">
  <div class="app-modal" (click)="$event.stopPropagation()">
    <h4>X√≥a nh√≥m</h4>
    <p>B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√≥m n√†y?</p>
    <div class="modal-actions">
      <!-- FIX: ph·∫£i set false, kh√¥ng ph·∫£i g·ªçi bi·∫øn -->
      <button class="cancel-btn" (click)="showDeleteConfirm=false">H·ªßy</button>
      <button class="submit danger" (click)="confirmDeleteGroup()">X√≥a</button>
    </div>
  </div>
</div>
