<div class="container-fluid">
  <app-full-page-loading [isLoading]="isLoading"></app-full-page-loading>
  <app-page-title title="Quản lý người dùng"></app-page-title>
  <div class="row">
    <div class="card" *ngIf="role!=ROLE.NHAN_VIEN" style="margin-bottom: 8px;">
      <div class="card-body" style="padding: 8px;">
        <form [formGroup]="searchForm" (submit)="search()">
          <div class="row align-items-end g-2">
            <div class="col-md-3">
              <label for="fullnameId" class="form-label mb-1" style="font-size: 13px;">Họ và tên</label>
              <input id="fullname" name="fullname" type="text" class="form-control form-control-sm" formControlName="fullname"
                maxlength="500">
            </div>
            <div class="col-md-3">
              <label for="phoneId" class="form-label mb-1" style="font-size: 13px;">SĐT</label>
              <input id="phone" name="phone" type="text" class="form-control form-control-sm" formControlName="phone" maxlength="500">
            </div>
            <div class="col-md-3" *ngIf="role===ROLE.ADMIN">
              <label class="form-label mb-1" style="font-size: 13px;">Công ty<span class="text-danger">*</span></label>
              <ng-select [items]="listCompany" bindLabel="name" bindValue="id" formControlName="companyId"
                placeholder="Chọn cửa hàng" [searchFn]="customSearchFn" style="font-size: 13px;">
                <ng-template ng-label-tmp let-item="item">
                  {{ item.phone }} - {{ item.name }}
                </ng-template>
                <ng-template ng-option-tmp let-item="item">
                  {{ item.phone }} - {{ item.name }}
                </ng-template>
              </ng-select>
            </div>
            <div class="col-md-3">
              <button type="submit" class="btn btn-primary btn-sm me-2"><i
                  class="fas fa-search"></i> Tìm kiếm</button>
              <button type="button" *ngIf="role!==ROLE.NHAN_VIEN" (click)="create()" class="btn btn-success btn-sm"><i
                  class="bx bx-plus-medical"></i> Thêm mới</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    <style>
      th {
        white-space: nowrap;
        color: #B5B7C0;
        font-size: 13px;
        font-family: 'Inter';
        font-weight: 500;
        padding: 8px !important;
      }

      .table-bordered td {
        background: white;
        padding: 6px 8px !important;
        font-size: 13px;
      }

      .table-bordered {
        border: 2px solid #dee2e6;
        margin-bottom: 0;
      }

      .table-bordered th,
      .table-bordered td {
        border: 1px solid #dee2e6;
        vertical-align: middle;
      }

      .table-bordered thead th {
        background-color: #f8f9fa;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
      }

      .table-bordered tbody tr {
        height: 35px;
      }

      .btn-sm {
        padding: 4px 10px;
        font-size: 13px;
      }

      /* Fix ng-select height to match form-control-sm */
      ng-select.ng-select ::ng-deep .ng-select-container {
        min-height: 31px !important;
        height: 31px !important;
      }

      ng-select.ng-select ::ng-deep .ng-value-container {
        padding-top: 0 !important;
        padding-bottom: 0 !important;
      }

      ng-select.ng-select ::ng-deep .ng-input input {
        font-size: 13px !important;
      }
    </style>
    <div class="card" style="margin-bottom: 0;">
      <div class="card-body" style="padding: 8px;">
        <div style="overflow-x: auto;">
          <table class="table table-bordered table-sm">
            <thead>
              <tr>
                <th style="width: 40px;">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" [(ngModel)]="selectedAll"
                      (change)="selectAllChange()">
                  </div>
                </th>
                <th style="width: 50px;">STT</th>
                <th style="min-width: 120px;">Tên đăng nhập</th>
                <th style="min-width: 150px;">Tên đầy đủ</th>
                <th style="min-width: 180px;">Email</th>
                <th style="width: 120px;">SĐT</th>
                <th style="width: 120px;">Loại tài khoản</th>
                <th style="width: 100px;">Vai trò</th>
                <th style="width: 120px;">Trạng thái</th>
                <th style="min-width: 180px;">Thao tác</th>
              </tr>
            </thead>
            <tbody *ngFor="let table of tables;let i=index">
              <tr>
                <td>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" [(ngModel)]="table.selected">
                  </div>
                </td>
                <td>{{ (currentPage * 10) + i + 1 }}</td>
                <td>
                  <div style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" [title]="table.username">
                    {{table.username}}
                  </div>
                </td>
                <td>
                  <div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" [title]="table.fullname">
                    {{table.fullname}}
                  </div>
                </td>
                <td>
                  <div style="max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" [title]="table.email">
                    {{table.email}}
                  </div>
                </td>
                <td>{{table.phone}}</td>
                <td>{{ labelAccountType[table?.accountType] || '-' }}</td>
                <td>
                  {{ roleLabelMap[table?.role] || 'Khách hàng' }}
                </td>
                <td>
                  {{labelStatus[table?.status]}}
                </td>
                <td style="white-space: nowrap;">
                  <button (click)="edit(table)" class="btn btn-sm" style="background: #0ECA9E;
    color: white;
    border-radius: 4px;
    border: 1px #0ECA9E solid;
    padding: 3px 6px;
    margin-right: 4px;
    font-size: 12px;">Cập nhật <img src="./assets/images/icon/edit.svg" style="width: 12px;" />
                  </button>
                  <button class="btn btn-sm" style="background: #2845FF;
    color: white;
    border-radius: 4px;
    border: 1px #2845FF solid;
    padding: 3px 6px;
    font-size: 12px;" (click)="resetPassword(table)">Mật khẩu <img src="./assets/images/icon/key.svg" style="width: 12px;" /></button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="d-flex justify-content-between align-items-center" style="padding-top: 8px; border-top: 1px solid #dee2e6;">
          <div class="pagination d-flex align-items-center gap-2">
            <button (click)="loadPage(currentPage - 1)" [disabled]="currentPage === 0"
              class="btn btn-outline-primary btn-sm">
              Previous
            </button>
            <span style="font-size: 13px;">Page {{ currentPage + 1 }} of {{ totalPages }}</span>
            <button (click)="loadPage(currentPage + 1)" [disabled]="currentPage >= totalPages - 1"
              class="btn btn-outline-primary btn-sm">
              Next
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
