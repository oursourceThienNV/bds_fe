<div class="container-fluid" style="margin-top: 32px;">
  <app-full-page-loading [isLoading]="isLoading"></app-full-page-loading>
  <app-page-title title="Qu·∫£n l√Ω c√¥ng vi·ªác "></app-page-title>
  <div class="row">
    <div class="card">
      <div class="card-body">
        <form [formGroup]="searchForm" (submit)="search()">
          <div class="row" *ngIf="isCheckView==='ds'">
            <div class="col-md-3">
              <div class="mb-4">
                <label for="nameId">M√£ c√¥ng vi·ªác </label>
                <input id="nameId" name="code" type="text" class="form-control" formControlName="code" maxlength="500">
              </div>
            </div>

            <div class="col-md-3">
              <div class="mb-4">
                <label>T√™n c√¥ng vi·ªác </label>
                <input id="phoneId" name="name" type="text" class="form-control" formControlName="name" maxlength="500">
              </div>
            </div>
            <div class="col-md-3">
              <div class="mb-4">
                <label>Ng∆∞·ªùi t·∫°o </label>
                <input id="phoneId" name="name" type="text" class="form-control" formControlName="userCreate"
                       maxlength="500">
              </div>
            </div>
            <div class="col-md-3">
              <div class="mb-4">
                <label>Ng∆∞·ªùi ph·ª• tr√°ch </label>
                <input id="phoneId" name="name" type="text" class="form-control" formControlName="assignedTo"
                       maxlength="500">
              </div>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2 mt-2 justify-content-center">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-search"></i> T√¨m ki·∫øm
            </button>
            <button type="button" (click)="create()" class="ml-2 btn btn-success">
              <i class="bx bx-plus-medical"></i> Th√™m m·ªõi
            </button>
          </div>
        </form>
      </div>
    </div>

    <style>
      .fc-today-button {
        display: none !important;
      }

      th {
        white-space: nowrap;
        color: #B5B7C0;
        font-size: 14px;
        font-family: 'Inter';
        font-weight: 500;
      }

      .table-bordered td {
        background: white;
      }

      .container-fluid {
        min-height: 100vh;
        height: auto;
      }

      .task-card {
        cursor: grab;
      }

      .task-card:active {
        cursor: grabbing;
      }
    </style>
    <button style="width: 200px;margin-left: 40px;" class="ml-2 btn btn-success" (click)="checkView('ds')">
      Danh s√°ch
    </button>
    <!--    <button  style="width: 200px;margin-left: 40px;" class="btn btn-primary"  (click)="checkView('hc')">-->
    <!--      H·∫°n ch√≥t-->
    <!--    </button>-->
    <button style="width: 200px;margin-left: 40px;" class="btn btn-primary" (click)="checkView('bo')">
      KanBan
    </button>
    <button style="width: 200px;margin-left: 40px;" class="btn btn-primary" (click)="checkView('ca')">
      Calendar
    </button>
    <button style="width: 200px;margin-left: 40px;" class="btn btn-primary" (click)="checkView('tl')">
      TimeLine
    </button>
    <div class="board" *ngIf="isCheckView=='hc'">
      <div class="progress-box box-red">
        <h4>Qu√° h·∫°n</h4>
        <div *ngFor="let task of tasksHC?.overdue" class="task-card" (click)="edit(task)">
          <span class="task-name">{{ task.taskName }}</span>
          <span class="task-assigned">üë§ {{ task.assignedTo }}</span>
        </div>
      </div>

      <div class="progress-box box-yellow">
        <h4>Trong h√¥m nay</h4>
        <div *ngFor="let task of tasksHC?.today" class="task-card" (click)="edit(task)">
          <span class="task-name">{{ task.taskName }}</span>
          <span class="task-assigned">üë§ {{ task.assignedTo }}</span>
        </div>
      </div>

      <div class="progress-box box-blue">
        <h4>Trong tu·∫ßn n√†y</h4>
        <div *ngFor="let task of tasksHC?.thisWeek" class="task-card" (click)="edit(task)">
          <span class="task-name">{{ task.taskName }}</span>
          <span class="task-assigned">üë§ {{ task.assignedTo }}</span>
        </div>
      </div>

      <div class="progress-box box-green">
        <h4>Trong tu·∫ßn sau</h4>
        <div *ngFor="let task of tasksHC?.nextWeek" class="task-card" (click)="edit(task)">
          <span class="task-name">{{ task.taskName }}</span>
          <span class="task-assigned">üë§ {{ task.assignedTo }}</span>
        </div>
      </div>

      <!--      <div class="progress-box box-purple">-->
      <!--        <h4>Trong th√°ng n√†y</h4>-->
      <!--        <div *ngFor="let task of tasksBoard?.thisMonth" class="task-card">-->
      <!--          <div class="task-header"><b>{{ task.taskName }}</b></div>-->
      <!--          <div class="task-header"><b>{{ task.assignedTo }}</b></div>-->
      <!--        </div>-->
      <!--      </div>-->
    </div>
    <div class="kanban-wrapper" *ngIf="isCheckView === 'bo'">
      <div class="kanban-container" cdkDropListGroup>
        <div class="kanban-column" *ngFor="let group of listStatus" cdkDropList [id]="'list-' + group.code"
             [cdkDropListConnectedTo]="dropListIds()" [cdkDropListData]="tasksBoard"
             (cdkDropListDropped)="onDropSimple($event, group.code)">

          <!-- Column Header -->
          <div class="kanban-column-header" [style.background]="group.color">
            <span class="column-title">{{ group.name }}</span>
          </div>

          <!-- Column Content -->
          <div class="kanban-column-content">
            <!-- Task Cards -->
            <div class="kanban-card" *ngFor="let task of getTasksByStatus(group.code)" cdkDrag [cdkDragData]="task"
                 (cdkDragStarted)="onDragStart(task)" [style.border-left-color]="task.color">

              <!-- Card Header: Code -->
              <div class="card-code">{{ task.code }}</div>

              <!-- Card Body: Title -->
              <div class="card-title">{{ task.taskName }}</div>

              <!-- Card Meta: Priority + Assignee -->
              <div class="card-meta">
                <span class="priority-chip" [style.background-color]="getPriorityBgColor(task.priority)"
                      [style.color]="getPriorityTextColor(task.priority)">
                  {{ getPriorityLabel(task.priority) }}
                </span>
                <span class="assignee-name">{{ task.assignedTo || 'Ch∆∞a giao' }}</span>
              </div>

              <!-- Card Footer: Due Date + Participants -->
              <div class="card-footer">
                <span class="due-date">
                  <i class="far fa-calendar-alt"></i>
                  {{ task.dueDate | date:'yyyy-MM-dd' }}
                </span>

                <!-- Participant Avatars -->
                <div class="participants-group" *ngIf="task.participants && task.participants.length > 0"
                     (click)="toggleParticipantsPanel($event, task)">
                  <div class="avatar" *ngFor="let participant of task.participants.slice(0, 3); let i = index"
                       [style.z-index]="task.participants.length - i" [title]="participant.name">
                    <span *ngIf="!participant.avatar">{{ getInitials(participant.name) }}</span>
                    <img *ngIf="participant.avatar" [src]="participant.avatar" [alt]="participant.name">
                  </div>
                  <div class="avatar avatar-more" *ngIf="task.participants.length > 3"
                       [title]="getRemainingParticipants(task.participants)">
                    +{{ task.participants.length - 3 }}
                  </div>
                </div>
              </div>

              <!-- Inline Participants Panel -->
              <div class="inline-participants-panel" *ngIf="isParticipantsPanelOpen(task.id)">
                <div class="panel-header-inline">
                  <span class="panel-title">{{ task.participants?.length || 0 }} ng∆∞·ªùi tham gia</span>
                </div>
                <div class="panel-body-inline">
                  <div class="participant-item-inline" *ngFor="let participant of task.participants">
                    <div class="participant-avatar-inline">
                      <span *ngIf="!participant.avatar">{{ getInitials(participant.name) }}</span>
                      <img *ngIf="participant.avatar" [src]="participant.avatar" [alt]="participant.name">
                    </div>
                    <span class="participant-name-inline">{{ participant.name }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Add New Task Button -->
            <button class="add-task-btn" *ngIf="!isInlineFor(group.code)" (click)="openInlineBoard(group.code)">
              <i class="fas fa-plus"></i> Th√™m c√¥ng vi·ªác
            </button>

            <!-- Inline Editor -->
            <div class="inline-editor-card" *ngIf="isInlineFor(group.code)">
              <input [id]="'boardTitle-' + (group.code == null ? 'null' : group.code)" [(ngModel)]="inlineBoardTitle"
                     (keydown)="onInlineBoardKeydown($event)" placeholder="Nh·∫≠p t√™n c√¥ng vi·ªác..." class="inline-input" />
              <div class="inline-actions">
                <button class="btn-save" (click)="saveInlineBoard()">L∆∞u</button>
                <button class="btn-cancel" (click)="cancelInlineBoard()">H·ªßy</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


  </div>

  <style>
    .board {
      display: flex;
      gap: 20px;
      margin: 20px 0;
    }

    .progress-box {
      flex: 1;
      /* 4 box b·∫±ng nhau */
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 20px;
      transition: all 0.3s ease;
      color: #fff;
    }

    .progress-box:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .progress-box h4 {
      margin-bottom: 15px;
      font-size: 20px;
      font-weight: 600;
    }

    .task-card {
      background-color: rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      padding: 12px;
      margin: 12px;
    }

    .task-header {
      font-size: 16px;
      font-weight: 500;
    }

    .task-name {
      font-size: 16px;
      font-weight: 600;
      color: white;
      /* ƒë·∫≠m */
      margin-bottom: 4px;
      display: block;
    }

    /* Ng∆∞·ªùi ƒë∆∞·ª£c assign */
    .task-assigned {
      font-size: 14px;
      font-weight: 400;
      color: white;
      /* x√°m nh·∫°t */
      display: block;
    }

    /* M√†u s·∫Øc cho t·ª´ng box */
    .box-red {
      background: linear-gradient(135deg, #EF4444, #B91C1C);
    }

    .box-blue {
      background: linear-gradient(135deg, #2563EB, #1E3A8A);
    }

    .box-green {
      background: linear-gradient(135deg, #10B981, #047857);
    }

    .box-yellow {
      background: linear-gradient(135deg, #F59E0B, #B45309);
    }

    .box-purple {
      background: linear-gradient(135deg, #8B5CF6, #6D28D9);
    }
  </style>

  <div class="card" *ngIf="isCheckView==='ds'">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered">
          <thead>
          <tr>
            <th style="text-align: center;">STT</th>
            <th>M√£ c√¥ng vi·ªác</th>
            <th>T√™n c√¥ng vi·ªác</th>
            <th style="text-align: center;">M·ª©c ƒë·ªô</th>
            <th style="text-align: center;">Tr·∫°ng th√°i</th>
            <!-- <th style="text-align: center;">File</th> -->
            <th>Ng∆∞·ªùi ph·ª• tr√°ch</th>
            <th style="text-align: center;">Ng√†y t·∫°o</th>
            <th style="text-align: center;">Deadline</th>
            <th>Ng∆∞·ªùi t·∫°o</th>
            <th style="text-align: center;"></th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let table of tables; let i = index">
            <td style="text-align: center;">{{ i + 1 + (currentPage * pageSize) }}</td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <span>{{ table.code }}</span>
                <i class="fas fa-chevron-up text-primary" style="cursor: pointer; font-size: 12px;"
                   (click)="openMiniTasksModal(table)" title="Xem t√°c v·ª• con"></i>
              </div>
            </td>
            <td>{{ table.taskName }}</td>
            <td style="text-align: center;">
              <ng-container [ngSwitch]="table?.priority">
                  <span *ngSwitchCase="'low'"
                        style="background-color: #FEF3C7; color: #F59E0B; padding: 4px 12px; border-radius: 4px; font-size: 13px; display: inline-block;">Th·∫•p</span>
                <span *ngSwitchCase="'medium'"
                      style="background-color: #DBEAFE; color: #3B82F6; padding: 4px 12px; border-radius: 4px; font-size: 13px; display: inline-block;">Trung
                    b√¨nh</span>
                <span *ngSwitchCase="'high'"
                      style="background-color: #FEE2E2; color: #EF4444; padding: 4px 12px; border-radius: 4px; font-size: 13px; display: inline-block;">Cao</span>
              </ng-container>
            </td>
            <td style="text-align: center;">
              <ng-container [ngSwitch]="table?.status">
                  <span *ngSwitchCase="'pending'"
                        style="background-color: #FEF3C7; color: #F59E0B; padding: 4px 12px; border-radius: 4px; font-size: 13px; display: inline-block;">Trung
                    b√¨nh</span>
                <span *ngSwitchCase="'completed'"
                      style="background-color: #D1FAE5; color: #10B981; padding: 4px 12px; border-radius: 4px; font-size: 13px; display: inline-block;">Ho√†n
                    th√†nh</span>
                <span *ngSwitchCase="'low'"
                      style="background-color: #DBEAFE; color: #3B82F6; padding: 4px 12px; border-radius: 4px; font-size: 13px; display: inline-block;">Th·∫•p</span>
                <span *ngSwitchCase="'high'"
                      style="background-color: #FEE2E2; color: #EF4444; padding: 4px 12px; border-radius: 4px; font-size: 13px; display: inline-block;">Cao</span>
                <span *ngSwitchDefault
                      style="padding: 4px 12px; border-radius: 4px; font-size: 13px; display: inline-block;"
                      [style.background-color]="table.color ? table.color + '20' : '#F3F4F6'"
                      [style.color]="table.color || '#6B7280'">{{table?.statusName}}</span>
              </ng-container>
            </td>
            <!-- <td style="text-align: center;">File</td> -->
            <td>{{table?.assignedTo}}</td>
            <td style="text-align: center;">{{ table?.createDt | date:'dd-MM-yyyy' }}</td>
            <td style="text-align: center;">{{ table?.dueDate | date:'dd-MM-yyyy'}}</td>
            <td>{{table?.createCode}} {{table?.userCreate}}</td>
            <td style="text-align: center;">
              <a (click)="edit(table)"
                 style="color: #5932EA; cursor: pointer; text-decoration: none; font-weight: 500;">Xem chi ti·∫øt</a>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <div class="row justify-content-md-between align-items-md-center mt-2">
        <div class="col-sm-12 col-md-5">
          <div class="pagination d-flex align-items-center gap-2">
            <button (click)="loadPage(currentPage - 1)" [disabled]="currentPage === 0" class="btn btn-outline-primary">
              Tr∆∞·ªõc
            </button>
            <span>Page {{ currentPage + 1 }} of {{ totalPages }}</span>
            <button (click)="loadPage(currentPage + 1)" [disabled]="currentPage >= totalPages - 1"
                    class="btn btn-outline-primary">
              Sau
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar Container with Scroll -->
  <div class="calendar-container" *ngIf="isCheckView === 'ca'">
    <full-calendar #calendar [options]="calendarOptions">
    </full-calendar>
  </div>

  <!-- Inline input ·ªü ƒë√∫ng gi·ªØa √¥ ng√†y - only show in calendar view -->
  <div *ngIf="inlineOpen && isCheckView === 'ca'" class="inline-editor"
       [ngStyle]="{ left: pos.left + 'px', top: pos.top + 'px', transform: 'translate(-50%, -50%)' }"
       style="position:absolute; z-index:9999;">
    <div style="
      background:#fff; border:1px solid #e5e7eb; border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,0.15); padding:8px; display:flex; gap:6px;
    ">
      <input id="inlineTitle" [(ngModel)]="inlineTitle" (keydown)="onInlineKeydown($event)"
             placeholder="T√™n c√¥ng vi·ªác..."
             style="padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; outline:none; width:220px;" />
      <button (click)="saveInline()"
              style="padding:8px 10px; border:none; border-radius:8px; background:#1E3A8A; color:#fff;">
        L∆∞u
      </button>
      <button (click)="cancelInline()"
              style="padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; background:#fff;">
        H·ªßy
      </button>
    </div>
  </div>
  <!-- Timeline View -->
  <div class="timeline-wrapper" *ngIf="isCheckView==='tl'">
    <div class="timeline-container">
      <div class="timeline-header">
        <div class="timeline-task-header">C√¥ng vi·ªác</div>
        <div class="timeline-dates-header">
          <div class="timeline-month-title">
            <button class="timeline-nav-btn" (click)="previousMonth()" title="Th√°ng tr∆∞·ªõc">
              <i class="fas fa-chevron-left"></i>
            </button>
            <span>Th√°ng {{ currentMonth + 1 }}, {{ currentYear }}</span>
            <button class="timeline-nav-btn" (click)="nextMonth()" title="Th√°ng sau">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
          <div class="timeline-days-row">
            <div class="timeline-day-cell" *ngFor="let d of daysArray">{{ d }}</div>
          </div>
        </div>
      </div>

      <div class="timeline-body">
        <div class="timeline-row" *ngFor="let task of tasksLine" (click)="edit(task)">
          <!-- Left Column: Task Info -->
          <div class="timeline-task-cell">
            <div class="timeline-task-name">{{ task.taskName }}</div>
            <div class="timeline-task-meta">{{ task.code }}_{{ task.assignedTo }}</div>
          </div>

          <!-- Right Column: Date Grid -->
          <div class="timeline-dates-grid">
            <div class="timeline-date-cell" *ngFor="let d of daysArray">
              <div class="timeline-bar" [ngClass]="statusClass(task, d)"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mini Tasks Modal -->
<div class="modal fade" [class.show]="showMiniTasksModal" [style.display]="showMiniTasksModal ? 'block' : 'none'"
     tabindex="-1" role="dialog" [attr.aria-modal]="showMiniTasksModal ? 'true' : null"
     [attr.aria-hidden]="showMiniTasksModal ? null : 'true'" (click)="closeMiniTasksModal()">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document"
       (click)="$event.stopPropagation()">
    <div class="modal-content mini-task-modal">

      <div class="modal-header border-0 pb-2">
        <div class="w-100">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h5 class="modal-title mb-1" style="font-weight: 600; color: #212529;">
                <span class="badge bg-secondary me-2" style="font-size: 11px;">{{ selectedTask?.code }}</span>
                {{ selectedTask?.name || selectedTask?.taskName }}
              </h5>
              <div class="text-muted" style="font-size: 13px;">
                <span class="me-3" *ngIf="selectedTask?.dueDate">üìÖ H·∫°n: {{ selectedTask?.dueDate | date:'dd/MM/yyyy HH:mm' }}</span>
                <span *ngIf="selectedTask?.priority">
                  üéØ ∆Øu ti√™n:
                  <span [ngClass]="{
                    'text-success': selectedTask?.priority === 'low',
                    'text-warning': selectedTask?.priority === 'medium',
                    'text-danger': selectedTask?.priority === 'high'
                  }" style="font-weight: 600;">
                    {{ selectedTask?.priority === 'low' ? 'Th·∫•p' :
                       selectedTask?.priority === 'medium' ? 'Trung b√¨nh' :
                       selectedTask?.priority === 'high' ? 'Cao' : selectedTask?.priority }}
                  </span>
                </span>
              </div>
              <div class="text-muted mt-1" style="font-size: 12px;" *ngIf="selectedTask?.description">
                {{ selectedTask?.description }}
              </div>
            </div>
            <button type="button" class="btn-close" aria-label="ƒê√≥ng" (click)="closeMiniTasksModal()"></button>
          </div>
        </div>
      </div>

      <div class="modal-body pt-2" style="max-height: 500px; overflow-y: auto; overflow-x: visible;">
        <div class="mini-task-count mb-3" style="font-size: 14px; color: #495057;">
          Mini Task ({{ miniTasks.length }}) - ƒê√£ ho√†n th√†nh: {{ selectedTask?.countDone || 0 }}/{{ selectedTask?.countSubtask || 0 }}
        </div>

        <div class="table-responsive">
          <table class="table mini-tasks-table mb-0">
            <thead>
            <tr>
              <th style="background-color: #d4e4f7; padding: 12px 16px; font-size: 13px; font-weight: 500;">M√£ task</th>
              <th style="background-color: #d4e4f7; padding: 12px 16px; font-size: 13px; font-weight: 500;">T√™n c√¥ng vi·ªác</th>
              <th style="background-color: #d4e4f7; padding: 12px 16px; font-size: 13px; font-weight: 500;">H·∫°n</th>
              <th style="background-color: #d4e4f7; padding: 12px 16px; font-size: 13px; font-weight: 500;">Tr·∫°ng th√°i</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let miniTask of miniTasks; let idx = index">
              <td style="padding: 12px 16px; font-size: 13px;">{{ miniTask.code }}</td>
              <td style="padding: 12px 16px; font-size: 13px;">{{ miniTask.title || miniTask.taskName }}</td>
              <td style="padding: 12px 16px; font-size: 13px;">
                {{ miniTask.dueDate ? (miniTask.dueDate | date:'dd/MM/yyyy HH:mm') : '-' }}
              </td>
              <td style="padding: 12px 16px;">
                <span
                  class="badge"
                  [style.background-color]="miniTask.statusColor || '#6c757d'"
                  [style.color]="'#ffffff'"
                  style="font-size: 12px; padding: 6px 12px; border-radius: 4px; font-weight: 500;">
                  {{ miniTask.statusName || 'N/A' }}
                </span>
              </td>
            </tr>
            <tr *ngIf="miniTasks.length === 0">
              <td colspan="4" style="padding: 20px; text-align: center; color: #6c757d;">
                Kh√¥ng c√≥ t√°c v·ª• con n√†o
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="modal-footer border-0 pt-3">
        <button type="button" class="btn btn-primary px-4" (click)="closeMiniTasksModal()"
                style="border-radius: 6px; font-size: 14px;">ƒê√≥ng</button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop -->
<div class="modal-backdrop fade" [class.show]="showMiniTasksModal"
     [style.display]="showMiniTasksModal ? 'block' : 'none'"></div>
