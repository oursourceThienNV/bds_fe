<div class="container-fluid px-2 px-md-3 mt-4 workspace-form position-relative">
  <button type="button" class="btn btn-light btn-sm" (click)="dismiss()" style="position: absolute; top: 8px; right: 8px;">×</button>
  <h2 class="mb-4">{{ title }}</h2>

  <form [formGroup]="dataForm" (ngSubmit)="save()">
    <div class="row mb-3">
      <div class="col-12 border rounded p-3">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label>Mã không gian<span class="text-danger">*</span></label>
            <input class="form-control" formControlName="code" type="text" readonly />
          </div>
          <div class="col-md-6 mb-3">
              <label>Tên không gian <span class="text-danger">*</span></label>
              
              <input 
                  class="form-control" 
                  formControlName="name" 
                  type="text" 
                  [class.is-invalid]="dataForm.get('name')?.invalid && (dataForm.get('name')?.dirty || dataForm.get('name')?.touched)"
              />

              <div *ngIf="dataForm.get('name')?.invalid && (dataForm.get('name')?.dirty || dataForm.get('name')?.touched)" class="text-danger mt-1 small">
                  <div *ngIf="dataForm.get('name')?.hasError('required')">
                      Tên không gian là bắt buộc.
                  </div>
              </div>
          </div>
          <div class="col-md-12 mb-3">
            <label>Mô tả</label>
            <textarea class="form-control" formControlName="description"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Nhóm -->
   <!-- <div class="row">-->
<!--      <div class="col-md-6 mb-3">-->
<!--        <label>Chọn nhóm người dùng</label>-->
<!--        <ng-select-->
<!--          [items]="listGroups"-->
<!--          bindLabel="name"-->
<!--          bindValue="id"-->
<!--          [(ngModel)]="selectedGroupId"-->
<!--          (change)="onGroupChange()"-->
<!--          [ngModelOptions]="{ standalone: true }"-->
<!--          placeholder="Chọn nhóm">-->
<!--        </ng-select>-->
<!--      </div>-->
<!--      <div class="col-md-6" *ngIf="groupUsers.length > 0">-->
<!--        <label>Danh sách người dùng trong nhóm:</label>-->
<!--        <table class="table table-bordered">-->
<!--          <thead>-->
<!--          <tr>-->
<!--            <th><input type="checkbox" [(ngModel)]="checkAllGroup" (change)="toggleAllGroupUsers(checkAllGroup)" [ngModelOptions]="{ standalone: true }"/></th>-->
<!--            <th>Username</th>-->
<!--            <th>Họ tên</th>-->
<!--          </tr>-->
<!--          </thead>-->
<!--          <tbody>-->
<!--          <tr *ngFor="let user of groupUsers">-->
<!--            <td><input type="checkbox" [(ngModel)]="user.selected" (change)="updateCheckAllGroupState()" [ngModelOptions]="{ standalone: true }" /></td>-->
<!--            <td>{{ user.username }}</td>-->
<!--            <td>{{ user.fullname }}</td>-->
<!--          </tr>-->
<!--          </tbody>-->
<!--        </table>-->
<!--        <div class="d-flex justify-content-end mb-2 gap-2">-->
<!--          <ng-select-->
<!--            [items]="workspaceRoles"-->
<!--            bindLabel="label"-->
<!--            bindValue="value"-->
<!--            [(ngModel)]="selectedGroupRole"-->
<!--            [ngModelOptions]="{ standalone: true }"-->
<!--            placeholder="Chọn vai trò">-->
<!--          </ng-select>-->
<!--          <button class="btn btn-primary" type="button" (click)="addSelectedGroupUsers()">Thêm</button>-->
<!--        </div>-->
<!--      </div>-->

<!--    </div> -->

    <!-- Danh sách nhóm -->

    <!-- Khu vực dưới: trái (chọn người và vai trò) - phải (bảng người dùng đã thêm) -->
    <div class="row mt-2 align-items-stretch">
      <!-- Trái: Chọn người dùng và vai trò -->
      <div class="col-md-5 mb-3 border rounded p-3 d-flex flex-column h-100" style="min-height: 426px;">
        <h5 class="mb-3 fw-bold">Thêm người dùng vào không gian</h5>
        <div>
          <label>Người dùng</label>
          <ng-select
            [items]="listUser"
            bindLabel="fullname"
            bindValue="id"
            [(ngModel)]="selectedUserToAdd"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Chọn người dùng">
            <ng-template ng-option-tmp let-item="item">
              {{ item.username }} - {{ item.fullname }}
            </ng-template>
          </ng-select>

          <div class="mt-3">
            <label>Vai trò</label>
            <ng-select
              [items]="workspaceRoles"
              bindLabel="label"
              bindValue="value"
              [(ngModel)]="selectedRoleToAdd"
              [ngModelOptions]="{ standalone: true }"
              placeholder="Chọn vai trò">
            </ng-select>
          </div>
        </div>

        <div class="mt-3">
          <button type="button" class="btn btn-success w-100" (click)="addUser()">Thêm người dùng</button>
        </div>
      </div>

      <!-- Phải: Danh sách người dùng đã thêm -->
      <div class="col-md-7 mb-3 border rounded p-3 d-flex flex-column h-100" style="min-height: 420px;">
        <h5 class="mb-3 fw-bold">Danh sách người dùng trong không gian</h5>
        <div class="d-flex flex-column h-100">
          <div class="flex-grow-1 overflow-auto" style="min-height: 320px; max-height: 320px;">
            <div class="table-responsive">
              <table class="table table-bordered table-hover mb-0">
                <thead>
                <tr>
                  <th><input type="checkbox" [(ngModel)]="checkAllAdded" (change)="toggleAllAddedUsers(checkAllAdded)" [ngModelOptions]="{ standalone: true }" /></th>
                  <th>Username</th>
                  <th>Họ tên</th>
                  <th>Vai trò</th>
                  <th class="text-center">Thao tác</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let user of addedUsers; let i = index">
                  <td><input type="checkbox" [(ngModel)]="user.checked" (change)="updateCheckAllAddedState()" [ngModelOptions]="{ standalone: true }" /></td>
                  <td>{{ user.username }}</td>
                  <td>{{ user.fullname }}</td>
                  <td>
                    <ng-select
                      [items]="workspaceRoles"
                      bindLabel="label"
                      bindValue="value"
                      [(ngModel)]="user.role"
                      [ngModelOptions]="{ standalone: true }"
                      class="form-control form-control-sm"
                      placeholder="Vai trò"
                      appendTo="body"
                      >
                      
                    </ng-select>
                  </td>
                  <td class="text-center">
                    <button type="button" class="btn btn-sm btn-danger" (click)="removeUser(i)">Xoá</button>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="d-flex justify-content-end mt-auto">
            <button class="btn btn-outline-danger btn-sm" (click)="removeCheckedUsers()" [disabled]="!hasCheckedUsers()">
              Xoá đã chọn
            </button> &nbsp; &nbsp;
           
          </div>
        </div>
      </div>
    </div>

    <!-- Nút submit -->
    <div class="mt-4 d-flex justify-content-end gap-2">
         <button type="button" class="btn btn-secondary" (click)="goBack()">Quay lại</button> &nbsp; &nbsp;
            <button type="submit" class="btn btn-primary">Lưu</button>
    </div>
  </form>
</div>
